{% set this_page = "neighbors" %}
{% extends "templates/static/layout.html.j2" %}

{% block title %}Neighbors{% endblock %}

{% block content %}
<div class="container pt-3">
  <h5>{{ this_page.title() }}</h5>
  <p>
    There are <b>{{ active_nodes_with_neighbors|count }}</b> active nodes with neighbors.
  </p>
  <div class="table-responsive">
    <table class="table table-striped table-bordered table-sm">
      <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col" colspan=2>Name</th>
          <th scope="col" colspan=3>Neighbors</th>
          <th scope="col" colspan=2>Seen</th>
        </tr>
        <tr>
          <th scope="col"></th>
          <th scope="col">Short</th>
          <th scope="col">Long</th>
          <th scope="col">Heard</th>
          <th scope="col">Heard By</th>
          <th scope="col">Interval</th>
          <th scope="col">Last</th>
          <th scope="col">Since</th>
        </tr>
      </thead>
      <tbody>
        {% for id, node in active_nodes_with_neighbors.items() %}
        <tr>
          <td class="p-0" style="width:50px;">
            {% if id %}
            {% set id = id|replace('!', '') %}
            <a href='node_{{ id }}.html'>
              <img src="https://api.dicebear.com/9.x/bottts-neutral/svg?seed={{ id }}" alt="Avatar"
                style="height: 50px; width: 50px;">
            </a>
            {% else %}
            <img src="https://api.dicebear.com/9.x/bottts-neutral/svg?seed={{ id }}" alt="Avatar"
              class="w-16 h-16 mb-1 object-cover">
            {{ id }}
            {% endif %}
          </td>
          <td style="color: #{{ '777' if node.shortname == 'UNK' else '000' }}">
            {% if id %}
            <a href='node_{{ id }}.html'>{{ node.shortname }}</a>
            {% else %}
            <span class="text-gray-500">{{ node.shortname }}</span>
            {% endif %}
          </td>
          <td style="color: #{{ '777' if node.shortname == 'UNK' else '000' }}">
            {{ node.longname }}
          </td>
          {% if node.neighborinfo %}
          <td>
            <table style="border-style: hidden !important;">
              {% for neighbor in node.neighborinfo.neighbors %}
              <tr style="background: none; border-style: hidden !important;">
                <td style="border-style: hidden !important;">
                  {% if neighbor.node_id in nodes %}
                  <a href="node_{{ nodes[neighbor.node_id].id }}.html">{{ nodes[neighbor.node_id].shortname }}</a>
                  {% else %}
                  <span class="text-secondary">UNK</span>
                  {% endif %}
                </td>
                <td style="border-style: hidden !important;">
                  SNR: {{ neighbor.snr }}
                </td>
                <td style="border-style: hidden !important;">
                  {% if neighbor.distance %}
                  {{ neighbor.distance }} km
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </table>
          </td>
          <td>
            <table>
              {% for nid, nnode in nodes.items() %}
              {% if nnode.neighborinfo %}
              {% for neighbor in nnode.neighborinfo.neighbors %}
              {% if utils.convert_node_id_from_int_to_hex(neighbor.node_id) == id %}
              <tr style="background: none;">
                <td style="border-style: hidden !important;">
                  {% if nid in nodes %}
                  <a href="node_{{ nid }}.html">{{ nodes[nid].shortname }}</a>
                  {% else %}
                  <span class="text-secondary">UNK</span>
                  {% endif %}
                </td>
                <td style="border-style: hidden !important;">
                  SNR: {{ neighbor.snr }}
                </td>
                <td style="border-style: hidden !important;">
                  {% set dist = utils.calculate_distance_between_nodes(nodes[nid], nodes[id]) %}
                  {% if dist %}
                  {{ dist }} km
                  {% endif %}
                </td>
              </tr>
              {% endif %}
              {% endfor %}
              {% endif %}
              {% endfor %}
            </table>
          </td>
          <td>{{ node.neighborinfo.node_broadcast_interval_secs }}s</td>
          {% else %}
          <td></td>
          {% endif %}
          <td>{{ node.last_seen_human }}</td>
          <td>{{ node.since.seconds }} secs</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <br><br>
  <br><br>
  <a href='nodes.json'>Download JSON</a>
</div>
{% endblock %}