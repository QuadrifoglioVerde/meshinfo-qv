{% set this_page = "telemetry" %}
{% extends "templates/static/layout.html.j2" %}

{% block title %}Telemetry{% endblock %}

{% block content %}
<div class="container pt-3">
  <h5>{{ this_page.title() }}</h5>
  <table class="table table-striped table-bordered table-sm">
    <thead>
      <tr>
        <th scope="col">Timestamp</th>
        <th scope="col">Node</th>
        <th scope="col">
          <img src="images/icons/up.svg" alt="Air Util TX" title="Air Util TX" style="height:18px">
        </th>
        <th scope="col">
          <img src="images/icons/down.svg" alt="Channel Util" title="Channel Util" style="height:18px">
        </th>
        <th scope="col">
          <img src="images/icons/battery.svg" alt="Battery" title="Battery" style="height:18px">
        </th>
        <th scope="col">Uptime</th>
        <th scope="col">
          <img src="images/icons/voltage.svg" alt="Voltage" title="Voltage" style="height:18px">
        </th>
        <th scope="col">
          <img src="images/icons/current.svg" alt="Current" title="Current" style="height:18px">
        </th>
        <th scope="col">
          <img src="images/icons/pressure.svg" alt="Barometric Pressure" title="Barometric Pressure"
            style="height:18px">
        </th>
        <th scope="col">
          <img src="images/icons/relative-humidity.svg" alt="Relative Humidity" title="Relative Humidity"
            style="height:18px">
        </th>
        <th scope="col">
          <img src="images/icons/temperature.svg" alt="Temperature" title="Temperature" style="height:18px">
        </th>
        <th scope="col">
          <img src="images/icons/resistance.svg" alt="Gas Resistance" title="Gas Resistance" style="height:18px">
        </th>
      </tr>
    </thead>
    <tbody>
      {% for item in telemetry[0:1000] %}
      {% set inode = nodes[item.from] %}
      <tr>
        <td>
          {% if 'timestamp' in item %}
          {{ datetime.fromtimestamp(item.timestamp).astimezone(zoneinfo) }}
          {% else %}
          <span>Unknown</span>
          {% endif %}
        </td>
        <td>
          {% if inode %}
          <a href="node_{{ inode.id }}.html">{{ inode.shortname }}</a>
          {% else %}
          <span>UNK</span>
          {% endif %}
        </td>
        <td>
          {% if item.payload.air_util_tx is defined %}
          {{ item.payload.air_util_tx | round(2) }}%
          {% endif %}
        </td>
        <td>
          {% if item.payload.channel_utilization is defined %}
          {{ item.payload.channel_utilization | round(1) }}%
          {% endif %}
        </td>
        <td>
          {% if item.payload.battery_level is defined %}
          {{ item.payload.battery_level | round(2) }}%
          {% endif %}
        </td>
        <td>
          {% if item.payload.uptime_seconds is defined %}
          {{ item.payload.uptime_seconds }}
          {% endif %}
        </td>
        <td>
          {% if item.payload.voltage is defined %}
          {% if item.payload.voltage is string %}
          {{ item.payload.voltage }}
          {% else %}
          {{ item.payload.voltage | round(2) }} V
          {% endif %}
          {% endif %}
          {% if item.payload.voltage_ch1 is defined and item.payload.voltage_ch2 is defined and item.payload.voltage_ch3
          is defined %}
          <table>
            <tr>
              <td>
                Ch1
              </td>
              <td>
                {{ item.payload.voltage_ch1 | round(2) }} V<br />
              </td>
            </tr>
            <tr>
              <td>
                Ch2
              </td>
              <td>
                {{ item.payload.voltage_ch2 | round(2) }} V<br />
              </td>
            </tr>
            <tr>
              <td>
                Ch3
              </td>
              <td>
                {{ item.payload.voltage_ch3 | round(2) }} V
              </td>
            </tr>
          </table>
          {% endif %}
        </td>
        <td>
          {% if 'current' in item.payload and item.payload.current is string %}
          {{ item.payload.current }}
          {% elif 'current' in item.payload %}
          {{ item.payload.current | round(2) }} mA
          {% endif %}
          {% if 'current_ch1' in item.payload and 'current_ch2' in item.payload and 'current_ch3' in item.payload %}
          <table>
            <tr>
              <td>
                Ch1
              </td>
              <td>
                {{ item.payload.current_ch1 | round(2) }} mA<br />
              </td>
            </tr>
            <tr>
              <td>
                Ch2
              </td>
              <td>
                {{ item.payload.current_ch2 | round(2) }} mA<br />
              </td>
            </tr>
            <tr>
              <td>
                Ch3
              </td>
              <td>
                {{ item.payload.current_ch3 | round(2) }} mA
              </td>
            </tr>
          </table>
          {% endif %}
        </td>
        <td>
          {% if item.payload.barometric_pressure is defined %}
          {{ item.payload.barometric_pressure | round(2) }} hPa
          {% endif %}
        </td>
        <td>
          {% if item.payload.relative_humidity is defined and item.payload.relative_humidity %}
          {% if item.payload.relative_humidity is string %}
          {{ item.payload.relative_humidity }}
          {% else %}
          {{ item.payload.relative_humidity | round(2) }}%
          {% endif %}
          {% endif %}
        </td>
        <td>
          {% if item.payload.temperature is defined %}
          {% if item.payload.temperature is number %}
          {{ item.payload.temperature | round(2) }}&deg;C
          {% else %}
          {{ item.payload.temperature }}
          {% endif %}
          {% endif %}
        </td>
        <td>
          {% if item.payload.gas_resistance is defined %}
          {{ item.payload.gas_resistance | round(2) }} Ohm
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}