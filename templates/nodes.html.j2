{% set this_page = "nodes" %}
{% extends "layout.html.j2" %}

{% block title %}Nodes | MeshInfo{% endblock %}

{% block content %}
{% if latest %}
{% set lnodeid = utils.convert_node_id_from_int_to_hex(latest["id"]) %}
{% set lnode = nodes[lnodeid] %}
<div class="p-3 mt-1 fw-bold" style="background: #F9F9D7;">
  ðŸ“Œ Welcome to our newest node, <a href="node_{{ lnodeid }}.html">{{ lnode.long_name }} ({{ lnode.short_name }})</a>.ðŸ‘‹
</div>
{% endif %}
<div class="container pt-3">
<h5>{{ this_page.title() }}</h5>
<p>
  There are <b>{{ active_nodes|count }}</b> active out of a total of <b>{{ nodes|count }}</b>.
</p>
<div class="table-responsive">
  <table class="table table-striped table-bordered table-sm">
    <thead>
      <tr>
        <th colspan="2" scope="col">ID</th>
        <th colspan="2" scope="col">Name</th>
        <th scope="col">HW</th>
        <th scope="col">FW</th>
        <th scope="col">Role</th>
        <th colspan="3" scope="col">Last Position</th>
        <th scope="col">Neighbors</th>
        <th colspan="4" scope="col">Telemetry</th>
        <th scope="col">Seen</th>
      </tr>
      <tr>
        <th scope="col">&nbsp;</th>
        <th scope="col">&nbsp;</th>
        <th scope="col">Short</th>
        <th scope="col">Long</th>
        <th scope="col">&nbsp;</th>
        <th scope="col">&nbsp;</th>
        <th scope="col">&nbsp;</th>
        <th scope="col">Altitude</th>
        <th scope="col">Latitude</th>
        <th scope="col">Longitude</th>
        <th scope="col">Count</th>
        <th scope="col"><img src="images/icons/battery.svg" style="height: 20px;" alt="Battery" title="Battery"></th>
        <th scope="col"><img src="images/icons/voltage.svg" style="height: 14px;" alt="Voltage" title="Voltage"></th>
        </th>
        <th scope="col"><img src="images/icons/up.svg" style="height: 14px;" alt="Air Util TX" title="Air Util TX"></th>
        </th>
        <th scope="col"><img src="images/icons/down.svg" style="height: 14px;" alt="Channel Util" title="Channel Util">
        </th>
        </th>
        <th scope="col">Since</th>
      </tr>
    <tbody>
      {% for id, node in active_nodes.items()|sort(attribute='1.short_name') %}
      <tr>
        <td class="p-0" style="width:50px;">
          <img src="https://api.dicebear.com/9.x/bottts-neutral/svg?seed={{ id }}" alt="Avatar"
            style="height: 50px; width: 50px;">
        </td>
        <td scope="col">
          {% if id %}
          {% set id = id|replace('!', '') %}
          <a href='node_{{ id }}.html'>{{ id }}</a>
          {% else %}
          {{ id }}
          {% endif %}
        </td>
        <td scope="col">
          {% if id %}
          {% set id = id|replace('!', '') %}
          <a href='node_{{ id }}.html'>{{ node.short_name }}</a>
          {% else %}
          {{ node.short_name }}
          {% endif %}
        </td>
        <td scope="col">
          {{ node.long_name }}
        </td>
        <td scope="col" class="text-center">
          {% if node.hw_model and node.hw_model in meshtastic_support.HardwareModel._value2member_map_ %}
          {% if meshtastic_support.HardwareModel(node.hw_model) and meshtastic_support.HardwareModel(node.hw_model) in
          meshtastic_support.HARDWARE_PHOTOS %}
          <img
            src="images/hardware/{{ meshtastic_support.HARDWARE_PHOTOS[meshtastic_support.HardwareModel(node.hw_model)] }}"
            alt="{{ meshtastic_support.HardwareModel(node.hw_model).name }}"
            title="{{ meshtastic_support.HardwareModel(node.hw_model).name }}" style="width: 50px;">
          {% endif %}
          {% endif %}
        </td>
        <td scope="col">
          {% if node.firmware_version %}
          {{ node.firmware_version }}
          {% endif %}
        </td>
        <td scope="col">
          {% if node.role is not none %}
          {% if node.role == 0 %}
          <span title="Client">C</span>
          {% elif node.role == 1 %}
          <span title="Client Mute">CM</span>
          {% elif node.role == 2 %}
          <span title="Router">R</span>
          {% elif node.role == 3 %}
          <span title="Router Client">RC</span>
          {% elif node.role == 4 %}
          <span title="Repeater">RE</span>
          {% elif node.role == 5 %}
          <span title="Tracker">T</span>
          {% elif node.role == 6 %}
          <span title="Sensor">S</span>
          {% elif node.role == 7 %}
          <span title="ATAK">A</span>
          {% elif node.role == 8 %}
          <span title="Client Hidden">CH</span>
          {% elif node.role == 9 %}
          <span title="Lost and Found">LF</span>
          {% elif node.role == 10 %}
          <span title="ATAK Tracker">AT</span>
          {% endif %}
          {% endif %}
        </td>
        {% if node.position %}
        <td  scope="col">
          {% if node.position.altitude %}
          {{ node.position.altitude }} m
          {% endif %}
        </td>
        <td  scope="col">{{ node.position.latitude or "" }}</td>
        <td  scope="col">{{ node.position.longitude or "" }}</td>
        {% else %}
        <td  scope="col"></td>
        <td  scope="col"></td>
        <td  scope="col"></td>
        {% endif %}
        {% if node.neighbors %}
        <td  scope="col">{{ node.neighbors|length or "" }}</td>
        {% else %}
        <td  scope="col"></td>
        {% endif %}
        {% if node.telemetry %}
          <td  scope="col">
            {% if 'battery_level' in node.telemetry %}
              {{ node.telemetry.battery_level }}%
            {% endif %}
          </td>
          <td  scope="col">
            {% if 'voltage' in node.telemetry %}
              {% if node.telemetry.voltage is number %}
                {{ node.telemetry.voltage|round(2) }}V
              {% else %}
                {{ node.telemetry.voltage }}
              {% endif %}
            {% endif %}
          </td>
          <td  scope="col">
            {% if 'air_util_tx' in node.telemetry %}
              {% if node.telemetry.air_util_tx is number %}
                {{ node.telemetry.air_util_tx|round(1) }}%
              {% else %}
                {{ node.telemetry.air_util_tx }}
              {% endif %}
            {% endif %}
          </td>
          <td  scope="col">
            {% if 'channel_utilization' in node.telemetry %}
              {% if node.telemetry.channel_utilization is number %}
                {{ node.telemetry.channel_utilization|round(1) }}%
              {% else %}
                {{ node.telemetry.channel_utilization }}
              {% endif %}
            {% endif %}
          </td>
          {% else %}
          <td scope="col"></td>
          <td scope="col"></td>
          <td scope="col"></td>
          <td scope="col"></td>
          {% endif %}
          <td scope="col">{{ utils.time_since(node.ts_seen) }}</td>
      </tr>
      {% endfor %}
    </tbody>

    </thead>
  </table>
</div>
</div>
{% endblock %}